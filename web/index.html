<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body {
        background: black;
	    background-image: url("new_wall.jpg");
	    background-size: cover;
        background-repeat: no-repeat;
        color: white;
}

.input,.input:focus {
        position: fixed;
        left: 0;
        color: green;
        top: calc(100% - 2.5rem);
	height: 3rem;
        overflow: hidden;
	background: black;
}

.output {
        position: fixed;
        left: 10%;
        top: 0;
	margin-top: 0;
        height: calc(100% - 3rem);
	padding: 0.5rem;
	padding-bottom: 0;
        overflow-y: auto;
	background-color: rgba(0,0,0,0.8);
        width: 80%;
	font-size: small;
}

hr {
        width: 100vw;
        color: #ba68c8;
}

.red {
        color: red;
}

.white {
        color: white;
}

.green {
        color: green;
}

.yellow {
        color: yellow;
}

.blue {
        color: blue;
}
.orange {
    color: #ff9800;
}
#input {
        border: None;
        color: #ff9800;
        background: black;
        width: 80vw;
}

</style>
<script>
let host = "127.0.0.1";
let socket=null;
if(window.location.hostname!="")
{
        host = window.location.hostname;
	socket = new WebSocket("wss://"+host+":9002");
}
else
{
	socket = new WebSocket("ws://"+host+":9002");
}

let clicked = false;
let aud = new Audio("sounds/piano.mp3");
function playMusik() 
{
    if(clicked == false) {
        aud.play();
        document.getElementById("symbol").className = "fa fa-volume-up";
        clicked = true;
    }

    else
    {
        aud.pause();
        document.getElementById("symbol").className = "fa fa-volume-off";
        clicked = false;
    }
}


let gPipelinedOutput = null;
let gPipelineNextEnter = false;
let listOfCommands = [];
let currentIter = -1;
function bdyonload()
{

        document.getElementById("input").addEventListener("keydown",function(event){
                if(event.key === "Enter")
                {
		    if(gPipelineNextEnter)
		    {
			gPipelineNextEnter = false;
			if(gPipelinedOutput!=null)
			{
			    printString(gPipelinedOutput);
			}
		    }
		    else
		    {
                        let st = document.getElementById("input").value;
                        let k = st.toLowerCase();
                        document.getElementById("input").value ="";
			printString('\x06'+k+'\n');
			listOfCommands.push(k);
                        socket.send(k);
                        let val = document.getElementById("output");
                        val.scrollTop = val.scrollHeight;
			currentIter = -1;
		    }
                }
		if(listOfCommands.length==0)
		    return;
		if(event.keyCode === 38)
		{
		    currentIter--;
		    if(currentIter<0)
			currentIter = listOfCommands.length-1;
		    document.getElementById("input").value = listOfCommands[currentIter];
		}
		else if(event.keyCode === 40)
		{
		    currentIter++;
		    if(currentIter == listOfCommands.length)
			currentIter = 0;
		    document.getElementById("input").value = listOfCommands[currentIter];
		}
        });
        document.getElementById("input").focus();
        
        socket.onmessage = function(event){console.log("Received: "+event.data);printString(event.data);};
}

function isspanret(isspan,colname)
{
        if(isspan)
                return "</span><span class='"+colname+"'>";
        else
                return "<span class='"+colname+"'>";
}

function parse_file(strin,x)
{
    name = '';
    for(let i = x+1; i < strin.length; i++)
	if(strin[i] == '\x07')
	{
	    console.log("Playing soundfile: "+name);
	    aud.pause();
	    aud = new Audio(name);
	    if(clicked) aud.play();
	    return i+1;
	}
	else
	    name+=strin[i]
}

function printString(theString)
{
    let out = "";
    let isspanopen = false;
    for(let i = 0; i < theString.length; i++)
    {
        if(theString[i] == '\n')
            ut+="<br class='line'>";
        else if(theString[i] == '\x01')
            out+=isspanret(isspanopen,"white");
        else if(theString[i] == '\x02')
            out+=isspanret(isspanopen,"red");
        else if(theString[i] == '\x03')
            out+=isspanret(isspanopen,"green");
        else if(theString[i] == '\x04')
            out+=isspanret(isspanopen,"yellow");
        else if(theString[i] == '\x05')
            out+=isspanret(isspanopen,"blue");
        else if(theString[i] == '\x06')
            out+=isspanret(isspanopen,"orange");
        else if(theString[i] == '$')
        {
            out+="<br class='line'>TECH GUY: Press Enter to continue...<br class='line'>";
            gPipelinedOutput = theString.substr(i+1);
            gPipelineNextEnter = true;
            break;
        }
        else{
                out+=theString[i];
        }
        if(theString[i] >= '\x01' && theString[i] <= '\x05')
                isspanopen = true;

    }
    if(isspanopen)
    {
        out+="</span>";
    }
	let outpt = document.getElementById("output");
	outpt.innerHTML += out;
	outpt.scrollTop = outpt.scrollHeight;
}

function openFullscreen(elem) {
  if (elem.requestFullscreen) {
    elem.requestFullscreen();
  } else if (elem.mozRequestFullScreen) { /* Firefox */
    elem.mozRequestFullScreen();
  } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
    elem.webkitRequestFullscreen();
  } else if (elem.msRequestFullscreen) { /* IE/Edge */
    elem.msRequestFullscreen();
  }
}

function hasFullscreen(elem) {
    let hasfull = false;
    if (elem.requestFullscreen) {
	hasfull = true;
  } else if (elem.mozRequestFullScreen) { /* Firefox */
	hasfull = true;
  } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
	hasfull = true;
  } else if (elem.msRequestFullscreen) { /* IE/Edge */
	hasfull = true;
  }
    return hasfull;
}

/* Close fullscreen */
function closeFullscreen(elem) {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.mozCancelFullScreen) { /* Firefox */
    document.mozCancelFullScreen();
  } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) { /* IE/Edge */
    document.msExitFullscreen();
  }
}
</script>
</head>

<body onload="bdyonload();return true;">
        <button onclick="playMusik();return true;"><i id="symbol" class= "fa fa-volume-off" style="font-size:18px"></i></button>
        <p id="output" class="output"></p>
        <div class="input">
                <hr>
                <span>$> <input type="text" id="input" style="display:inline-block" placeholder='type command here...'/></span>
        </div>
</body>
